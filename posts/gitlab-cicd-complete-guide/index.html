<!doctype html><html lang=zh-tw><head><title>GitLab CI/CD 完整配置指南</title><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.a671c53c7cf3735bfdfe99730357e6f244a0007a0e507b307277a2e095f98127.css integrity="sha256-pnHFPHzzc1v9/plzA1fm8kSgAHoOUHswcnei4JX5gSc="><link rel=icon type=image/png href=/images/site/favicon_hu_6b83fda92133ca8.jpeg><meta property="og:title" content="Clarence 個人介紹"><meta property="og:type" content="website"><meta property="og:description" content="本網站為 Clarence 個人簡歷紀錄."><meta property="og:image" content="/clarencetw-og.png"><meta property="og:url" content="https://clarence.tw"><meta name=description content="分享 GitLab CI/CD 的完整配置經驗，從基礎設定到進階部署策略"><script async src="https://www.googletagmanager.com/gtag/js?id=G-PG4DH6TDZN"></script><script>var dnt,doNotTrack=!1;if(null&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PG4DH6TDZN")}</script><script src=https://cdn.counter.dev/script.js data-id=me@clarence.tw data-utcoffset=1></script><script data-goatcounter=https://clarence.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid bg-secondary wrapper"><nav class="navbar navbar-expand-xl top-navbar shadow" id=top-navbar><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<i data-feather=sidebar></i>
</button>
<a class=navbar-brand href=/><img src=/images/site/main-logo_hu_6b83fda92133ca8.jpeg id=logo alt=Logo>
Clarence</a>
<button class="navbar-toggler navbar-light" id=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#top-nav-items aria-label=menu>
<i data-feather=menu></i></button><div class="collapse navbar-collapse dynamic-navbar" id=top-nav-items><ul class="nav navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=/#home>首頁</a></li><li class=nav-item><a class=nav-link href=/#about>關於我</a></li><li class=nav-item><a class=nav-link href=/#skills>技能</a></li><li class=nav-item><a class=nav-link href=/#experiences>經歷</a></li><li class=nav-item><a class=nav-link href=/#education>學歷</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>更多的</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/#projects>專案</a>
<a class=dropdown-item href=/#publications>出版</a>
<a class=dropdown-item href=/#accomplishments>成就</a></div></li><div id=top-navbar-divider></div><li class=nav-item><a class=nav-link id=blog-link href=/posts>文章</a></li><li class=nav-item><a class=nav-link id=note-link href=/notes>筆記</a></li><li class=nav-item><a class=nav-link href=https://blog.clarence.tw/>部落格</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=theme-icon src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=theme-icon src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=theme-icon src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu_6b83fda92133ca8.jpeg class=d-none id=main-logo alt=Logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=搜尋 data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts/ data-filter=all>文章</a></li><div class=subtree><li><a class=list-link href=/posts/hosting-high-bandwidth-web-server/ title=託管高流量網站經驗>託管高流量網站經驗</a></li><li><a class="active list-link" href=/posts/gitlab-cicd-complete-guide/ title="GitLab CI/CD 完整配置指南">GitLab CI/CD 完整配置指南</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ms-auto align-self-lg-center"><img class=rounded-circle src=/images/author/clarence_hu_33d8b0311914a20e.jpg alt="Author Image"><h5 class=author-name>Clarence Lin</h5><p class=text-muted>Tuesday, January 30, 2024 | 3 分鐘</p></div><div class=title><h1>GitLab CI/CD 完整配置指南</h1></div><div class=tags><ul style=padding-left:0><li class=rounded><a href=/tags/gitlab/ class="btn btn-sm btn-info">GitLab</a></li><li class=rounded><a href=/tags/ci/cd/ class="btn btn-sm btn-info">CI/CD</a></li><li class=rounded><a href=/tags/devops/ class="btn btn-sm btn-info">DevOps</a></li><li class=rounded><a href=/tags/docker/ class="btn btn-sm btn-info">Docker</a></li><li class=rounded><a href=/tags/automation/ class="btn btn-sm btn-info">Automation</a></li></ul></div><div class=post-content id=post-content><p>在企業 DevOps 實踐中，我負責建置和維護 GitLab CI/CD 流程，涵蓋從程式碼提交到生產部署的完整自動化。這篇文章將分享 GitLab CI/CD 的基礎配置經驗。</p><h2 id=gitlab-cicd-基礎架構>GitLab CI/CD 基礎架構</h2><h3 id=1-gitlab-runner-部署>1. GitLab Runner 部署</h3><p><strong>自建 Runner 配置：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安裝 GitLab Runner</span>
</span></span><span style=display:flex><span>curl -L <span style=color:#e6db74>&#34;https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh&#34;</span> | sudo bash
</span></span><span style=display:flex><span>sudo apt-get install gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 註冊 Runner</span>
</span></span><span style=display:flex><span>sudo gitlab-runner register <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url <span style=color:#e6db74>&#34;https://gitlab.company.com/&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --registration-token <span style=color:#e6db74>&#34;YOUR_TOKEN&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --executor <span style=color:#e6db74>&#34;docker&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --docker-image <span style=color:#e6db74>&#34;alpine:latest&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --description <span style=color:#e6db74>&#34;Production Runner&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --tag-list <span style=color:#e6db74>&#34;production,docker&#34;</span>
</span></span></code></pre></div><p><strong>Docker-in-Docker 配置：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># /etc/gitlab-runner/config.toml</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>concurrent</span> = <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>check_interval</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>session_server</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>session_timeout</span> = <span style=color:#ae81ff>1800</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>runners</span>]]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;docker-runner&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://gitlab.company.com/&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span> = <span style=color:#e6db74>&#34;YOUR_TOKEN&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>executor</span> = <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>custom_build_dir</span>]
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>cache</span>]
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>s3</span>]
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>gcs</span>]
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>azure</span>]
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>docker</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tls_verify</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>image</span> = <span style=color:#e6db74>&#34;docker:20.10.16&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>privileged</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>disable_entrypoint_overwrite</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>oom_kill_disable</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>disable_cache</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>volumes</span> = [<span style=color:#e6db74>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>, <span style=color:#e6db74>&#34;/cache&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shm_size</span> = <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=gitlab-ciyml-基礎範例>.gitlab-ci.yml 基礎範例</h2><h3 id=簡單的-nodejs-專案配置>簡單的 Node.js 專案配置</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># .gitlab-ci.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>image</span>: <span style=color:#ae81ff>node:18-alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定義階段</span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 快取設定</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cache</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>node_modules/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安裝依賴</span>
</span></span><span style=display:flex><span><span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>npm ci</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 測試階段</span>
</span></span><span style=display:flex><span><span style=color:#f92672>test</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm run test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>merge_requests</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 建置階段</span>
</span></span><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:20.10.16</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:20.10.16-dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 部署到測試環境</span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy:staging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Deploying to staging environment&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>kubectl set image deployment/myapp myapp=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>staging</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><h2 id=harbor-私有映像倉庫整合>Harbor 私有映像倉庫整合</h2><h3 id=harbor-設定與使用>Harbor 設定與使用</h3><p>我們使用 Harbor 作為私有 Docker 映像倉庫，提供安全且高效的映像管理。</p><p><strong>Harbor 基本配置：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 使用 Harbor 作為映像倉庫</span>
</span></span><span style=display:flex><span><span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>HARBOR_REGISTRY</span>: <span style=color:#e6db74>&#34;harbor.company.com&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>HARBOR_PROJECT</span>: <span style=color:#e6db74>&#34;myproject&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>IMAGE_NAME</span>: <span style=color:#e6db74>&#34;$HARBOR_REGISTRY/$HARBOR_PROJECT/myapp&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build:harbor</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:20.10.16</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:20.10.16-dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 登入 Harbor</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker login -u $HARBOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_REGISTRY</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 建置並推送到 Harbor</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker build -t $IMAGE_NAME:$CI_COMMIT_SHA .</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker build -t $IMAGE_NAME:latest .</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker push $IMAGE_NAME:$CI_COMMIT_SHA</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker push $IMAGE_NAME:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><p><strong>Harbor 映像掃描：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Harbor 內建的映像安全掃描</span>
</span></span><span style=display:flex><span><span style=color:#f92672>scan:harbor</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apk add --no-cache curl jq</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 觸發 Harbor 掃描</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      curl -X POST -u &#34;$HARBOR_USERNAME:$HARBOR_PASSWORD&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;$HARBOR_REGISTRY/api/v2.0/projects/$HARBOR_PROJECT/repositories/myapp/artifacts/$CI_COMMIT_SHA/scan&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等待掃描完成並取得結果</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sleep 30</span>
</span></span><span style=display:flex><span>    - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      curl -u &#34;$HARBOR_USERNAME:$HARBOR_PASSWORD&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;$HARBOR_REGISTRY/api/v2.0/projects/$HARBOR_PROJECT/repositories/myapp/artifacts/$CI_COMMIT_SHA&#34; | jq &#39;.scan_overview&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><h2 id=簡化的多環境部署>簡化的多環境部署</h2><h3 id=基礎部署範例>基礎部署範例</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 簡單的多環境部署</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.deploy_template</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apk add --no-cache kubectl</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>kubectl set image deployment/$APP_NAME $APP_NAME=$IMAGE_NAME:$CI_COMMIT_SHA</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy:staging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>extends</span>: <span style=color:#ae81ff>.deploy_template</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>APP_NAME</span>: <span style=color:#e6db74>&#34;myapp-staging&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>staging</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>develop</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy:production</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>extends</span>: <span style=color:#ae81ff>.deploy_template</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>APP_NAME</span>: <span style=color:#e6db74>&#34;myapp-prod&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>production</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>: <span style=color:#ae81ff>manual</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><h2 id=docker-整合>Docker 整合</h2><h3 id=dockerfile-最佳實踐>Dockerfile 最佳實踐</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 多階段建置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>node:18-alpine</span> <span style=color:#66d9ef>AS</span> <span style=color:#e6db74>builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm ci --only<span style=color:#f92672>=</span>production <span style=color:#f92672>&amp;&amp;</span> npm cache clean --force<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>node:18-alpine</span> <span style=color:#66d9ef>AS</span> <span style=color:#e6db74>runtime</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup -g <span style=color:#ae81ff>1001</span> -S nodejs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> adduser -S nextjs -u <span style=color:#ae81ff>1001</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/node_modules ./node_modules<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span> <span style=color:#e6db74>nextjs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span> <span style=color:#e6db74>3000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;npm&#34;</span>, <span style=color:#e6db74>&#34;start&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=docker-compose-測試環境>Docker Compose 測試環境</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># docker-compose.test.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.8&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>app</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NODE_ENV=test</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>DATABASE_URL=postgresql://test:test@db:5432/testdb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>redis</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:13</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>testdb</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  <span style=color:#f92672>redis</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>redis:6-alpine</span>
</span></span></code></pre></div><h2 id=基礎優化技巧>基礎優化技巧</h2><h3 id=快取設定>快取設定</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 簡單的快取配置</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cache</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>node_modules/</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>dist/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分支別快取</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cache</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;$CI_COMMIT_REF_SLUG&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>node_modules/</span>
</span></span></code></pre></div><h2 id=故障排除>故障排除</h2><h3 id=常見問題解決>常見問題解決</h3><p><strong>問題 1：Runner 記憶體不足</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># config.toml</span>
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>runners</span>]]
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>runners</span>.<span style=color:#a6e22e>docker</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memory</span> = <span style=color:#e6db74>&#34;4g&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memory_swap</span> = <span style=color:#e6db74>&#34;4g&#34;</span>
</span></span></code></pre></div><p><strong>問題 2：網路連線問題</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 增加重試機制</span>
</span></span><span style=display:flex><span><span style=color:#f92672>retry</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>max</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>when</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>runner_system_failure</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>stuck_or_timeout_failure</span>
</span></span></code></pre></div><p><strong>問題 3：權限問題</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 檢查 Runner 權限</span>
</span></span><span style=display:flex><span>sudo usermod -aG docker gitlab-runner
</span></span><span style=display:flex><span>sudo systemctl restart gitlab-runner
</span></span></code></pre></div><h2 id=結語>結語</h2><p>GitLab CI/CD 是一個實用的 DevOps 工具，透過簡單的配置就能建立基礎的自動化部署流程。關鍵在於：</p><ol><li><strong>簡單開始</strong>：從基礎的測試、建置、部署開始</li><li><strong>Harbor 整合</strong>：使用私有映像倉庫確保安全性</li><li><strong>逐步優化</strong>：根據需求逐步加入更多功能</li><li><strong>模組化設計</strong>：使用 extends 減少重複配置</li></ol><p>從簡單的配置開始，逐步建立適合團隊的 CI/CD 流程，可以有效提升開發效率。</p></div><div class="row ps-3 pe-3"><div class="col-md-6 share-buttons"><strong>分享:</strong>
<a class="btn icon-button bg-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn icon-button bg-twitter" href="https://twitter.com/share?url=https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f&text=GitLab%20CI%2fCD%20%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae%e6%8c%87%e5%8d%97&via=Clarence" target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn icon-button bg-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f&title=GitLab%20CI%2fCD%20%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae%e6%8c%87%e5%8d%97" target=_blank><i class="fab fa-reddit"></i>
</a><a class="btn icon-button bg-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f&title=GitLab%20CI%2fCD%20%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae%e6%8c%87%e5%8d%97" target=_blank><i class="fab fa-linkedin"></i>
</a><a class="btn icon-button bg-whatsapp" href="https://api.whatsapp.com/send?text=GitLab%20CI%2fCD%20%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae%e6%8c%87%e5%8d%97 https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f" target=_blank><i class="fab fa-whatsapp"></i>
</a><a class="btn icon-button" href="mailto:?subject=GitLab%20CI%2fCD%20%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae%e6%8c%87%e5%8d%97&body=https%3a%2f%2fclarence.tw%2fposts%2fgitlab-cicd-complete-guide%2f" target=_blank><i class="fas fa-envelope-open-text"></i></a></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/clarencetw/clarencetw.github.io/edit/master/content/posts/gitlab-cicd-complete-guide/index.md title=改善此頁面 target=_blank rel=noopener><i class="fas fa-code-branch"></i>
改善此頁面</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/hosting-high-bandwidth-web-server/ title=託管高流量網站經驗 class="btn filled-button"><div><i class="fas fa-chevron-circle-left"></i> 上一篇</div><div class=next-prev-text>託管高流量網站經驗</div></a></div></div><hr><script src=https://giscus.app/client.js data-repo=clarencetw/clarencetw.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjczMDk2OA==" data-category=General data-category-id=DIC_kwDOAP9LWM4CSqIm data-mapping=url data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang crossorigin=anonymous async></script></div></div></div><a id=scroll-to-top class=btn type=button data-bs-toggle=tooltip data-bs-placement=left title="Scroll to top"><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center ps-3">目錄</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#gitlab-cicd-基礎架構>GitLab CI/CD 基礎架構</a><ul><li><a href=#1-gitlab-runner-部署>1. GitLab Runner 部署</a></li></ul></li><li><a href=#gitlab-ciyml-基礎範例>.gitlab-ci.yml 基礎範例</a><ul><li><a href=#簡單的-nodejs-專案配置>簡單的 Node.js 專案配置</a></li></ul></li><li><a href=#harbor-私有映像倉庫整合>Harbor 私有映像倉庫整合</a><ul><li><a href=#harbor-設定與使用>Harbor 設定與使用</a></li></ul></li><li><a href=#簡化的多環境部署>簡化的多環境部署</a><ul><li><a href=#基礎部署範例>基礎部署範例</a></li></ul></li><li><a href=#docker-整合>Docker 整合</a><ul><li><a href=#dockerfile-最佳實踐>Dockerfile 最佳實踐</a></li><li><a href=#docker-compose-測試環境>Docker Compose 測試環境</a></li></ul></li><li><a href=#基礎優化技巧>基礎優化技巧</a><ul><li><a href=#快取設定>快取設定</a></li></ul></li><li><a href=#故障排除>故障排除</a><ul><li><a href=#常見問題解決>常見問題解決</a></li></ul></li><li><a href=#結語>結語</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-start"><div class="col-md-4 col-sm-12"><h5>導覽列</h5><ul><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#about>關於我</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#experiences>經歷</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#education>學歷</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#projects>專案</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#publications>出版</a></li><li class=nav-item><a class=smooth-scroll href=https://clarence.tw/#accomplishments>成就</a></li><li class=nav-item><a class=smooth-scroll href=https://blog.clarence.tw/>部落格</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>聯絡方式:</h5><ul><li><a href=mailto:me@clarence.tw target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>me@clarence.tw</span></a></li><li><a href=https://github.com/clarencetw target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>clarencetw</span></a></li><li><a href=https://www.linkedin.com/in/clarencetw target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>Clarence Lin</span></a></li><li><a href=https://stackoverflow.com/users/19384998/clarence target=_blank rel=noopener><span><i class="fab fa-stack-overflow"></i></span> <span>Clarence</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-start"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu_b3360284c55cf72d.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2024 Copyright.</div><div class="col-md-4 text-end"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.60cd30f1a829138bd807751c435466cb8538c20fff0c6a6a59c0ca7ac5869bd6.js integrity="sha256-YM0w8agpE4vYB3UcQ1Rmy4U4wg//DGpqWcDKesWGm9Y=" defer></script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=clarencetw data-description="Support me on Buy me a coffee!" data-message="Buy me a coffee!" data-color=#FFDD00 data-position=Right data-x_margin=10 data-y_margin=18></script></body></html>